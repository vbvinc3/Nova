name: Cloudflare-RDP
on:
  workflow_dispatch:

jobs:
  rdp-access:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Enable RDP Service
        run: |
          Write-Host "üîß Enabling Remote Desktop..."
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
            -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
            -Name "UserAuthentication" -Value 0 -Force
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Write-Host "‚úÖ RDP Enabled Successfully"

      - name: Create Secure RDP User
        run: |
          Write-Host "üë§ Creating Secure RDP User..."
          Add-Type -AssemblyName System.Security
          $chars = ([char[]](33..126))
          $password = -join (1..15 | ForEach-Object { $chars | Get-Random })
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          if (-not (Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires
          }
          Add-LocalGroupMember -Group "Administrators" -Member "RDP" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP" -ErrorAction SilentlyContinue
          echo "RDP_USER=RDP" >> $env:GITHUB_ENV
          echo "RDP_PASS=$password" >> $env:GITHUB_ENV
          Write-Host "‚úÖ User Created: RDP / $password"

      - name: Install Cloudflared
        run: |
          Write-Host "üåê Installing Cloudflared..."
          $path = "$env:ProgramFiles\cloudflared.exe"
          Invoke-WebRequest https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile $path
          if (-not (Test-Path $path)) { Write-Error "‚ùå Cloudflared installation failed!"; exit 1 }
          Write-Host "‚úÖ Cloudflared Installed Successfully"

      - name: Configure and Start Cloudflare Tunnel
        env:
          CLOUDFLARE_TOKEN: ${{ secrets.CLOUDFLARED_AUTH_TOKEN }}
        run: |
          $ErrorActionPreference = "Continue"
          Write-Host "üîë Starting Cloudflare Tunnel setup..."
          $exe = "$env:ProgramFiles\cloudflared.exe"
          $configDir = "C:\ProgramData\cloudflared"
          New-Item -ItemType Directory -Force -Path $configDir | Out-Null
          $configFile = "$configDir\config.yml"
          
          # Write config file
          $yaml = @"
          tunnel: rdp-tunnel
          credentials-file: C:\ProgramData\cloudflared\credentials.json
          ingress:
            - hostname: rdp.crossxcel.com
              service: tcp://localhost:3389
            - service: http_status:404
          "@
          $yaml | Out-File $configFile -Encoding ascii
          
          # Install service
          try {
            & $exe service install $env:CLOUDFLARE_TOKEN
          } catch {
            Write-Host "‚ö†Ô∏è Service install failed, retrying..."
          }

          # Create tunnel (ignore if already exists)
          try {
            & $exe tunnel create rdp-tunnel
          } catch {
            Write-Host "‚ÑπÔ∏è Tunnel already exists, skipping create step."
          }

          # Link DNS route
          try {
            & $exe tunnel route dns rdp-tunnel rdp.crossxcel.com
          } catch {
            Write-Host "‚ÑπÔ∏è DNS already routed."
          }

          # Start tunnel
          try {
            Start-Process -NoNewWindow -FilePath $exe -ArgumentList "tunnel", "run", "rdp-tunnel"
            Start-Sleep -Seconds 15
          } catch {
            Write-Host "‚ö†Ô∏è Tunnel start failed, retrying..."
            Start-Sleep -Seconds 10
            Start-Process -NoNewWindow -FilePath $exe -ArgumentList "tunnel", "run", "rdp-tunnel"
          }

          Write-Host "‚úÖ Cloudflare Tunnel Active ‚Üí rdp.crossxcel.com"

      - name: Show RDP Info
        run: |
          Write-Host ""
          Write-Host "==============================="
          Write-Host "üåê RDP via Cloudflare Active!"
          Write-Host "Host: rdp.crossxcel.com"
          Write-Host "Username: $env:RDP_USER"
          Write-Host "Password: $env:RDP_PASS"
          Write-Host "==============================="
          Write-Host ""

      - name: Keep RDP Alive
        run: |
          while ($true) {
            Write-Host "[$(Get-Date)] ‚úÖ RDP Tunnel Running Smoothly..."
            Start-Sleep -Seconds 300
          }
