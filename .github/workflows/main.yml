name: Cloudflare-RDP
on:
  workflow_dispatch:

jobs:
  rdp-access:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Enable RDP Service
        run: |
          Write-Host "üîß Enabling Remote Desktop..."
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
            -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
            -Name "UserAuthentication" -Value 0 -Force
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Write-Host "‚úÖ RDP Enabled Successfully"

      - name: Create Secure RDP User
        run: |
          Write-Host "üë§ Creating Secure RDP User..."
          $password = -join ((48..57) + (65..90) + (97..122) | Get-Random -Count 20 | ForEach-Object {[char]$_})
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          if (-not (Get-LocalUser -Name "RDPUser" -ErrorAction SilentlyContinue)) {
            New-LocalUser -Name "RDPUser" -Password $securePass -PasswordNeverExpires:$true
          } else {
            Set-LocalUser -Name "RDPUser" -Password $securePass
          }
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDPUser" -ErrorAction SilentlyContinue
          echo "RDP_PASS=$password" >> $env:GITHUB_ENV
          Write-Host "‚úÖ User Created: RDPUser"
          Write-Host "üîë Password: $password"

      - name: Install Cloudflared
        run: |
          Write-Host "üåê Installing Cloudflared..."
          $path = "$env:ProgramFiles\cloudflared\cloudflared.exe"
          New-Item -ItemType Directory -Force -Path "$env:ProgramFiles\cloudflared" | Out-Null
          Invoke-WebRequest https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe -OutFile $path
          if (-not (Test-Path $path)) { 
            Write-Error "‚ùå Cloudflared installation failed!"
            exit 1 
          }
          Write-Host "‚úÖ Cloudflared Installed Successfully"

      - name: Start Cloudflare Tunnel with Token
        env:
          TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
        run: |
          Write-Host "üîë Starting Cloudflare Tunnel with token..."
          $exe = "$env:ProgramFiles\cloudflared\cloudflared.exe"
          
          if ([string]::IsNullOrWhiteSpace($env:TUNNEL_TOKEN)) {
            Write-Error "‚ùå CLOUDFLARE_TUNNEL_TOKEN secret is not set!"
            Write-Host "Please create a tunnel at https://one.dash.cloudflare.com/ and add the token to GitHub secrets"
            exit 1
          }
          
          # Start tunnel in background using token
          Start-Process -NoNewWindow -FilePath $exe -ArgumentList "tunnel", "--no-autoupdate", "run", "--token", "$env:TUNNEL_TOKEN"
          
          Write-Host "‚è≥ Waiting for tunnel to establish..."
          Start-Sleep -Seconds 20
          
          # Verify tunnel is running
          $process = Get-Process cloudflared -ErrorAction SilentlyContinue
          if ($process) {
            Write-Host "‚úÖ Cloudflare Tunnel is running (PID: $($process.Id))"
          } else {
            Write-Error "‚ùå Tunnel failed to start!"
            exit 1
          }

      - name: Display Connection Info
        run: |
          Write-Host ""
          Write-Host "=========================================="
          Write-Host "üåê RDP Connection Ready!"
          Write-Host "=========================================="
          Write-Host "Host: Check your Cloudflare Tunnel dashboard"
          Write-Host "      https://one.dash.cloudflare.com/"
          Write-Host "Username: RDPUser"
          Write-Host "Password: $env:RDP_PASS"
          Write-Host "=========================================="
          Write-Host ""
          Write-Host "‚ö†Ô∏è  This session will run for 6 hours max"
          Write-Host ""

      - name: Keep Session Alive
        env:
          TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
        run: |
          $count = 0
          while ($true) {
            $count++
            $elapsed = $count * 5
            Write-Host "[$elapsed min] üü¢ Session active - Tunnel running"
            
            # Check if cloudflared is still running (check all variations)
            $process = Get-Process -Name "*cloudflared*" -ErrorAction SilentlyContinue
            if (-not $process) {
              Write-Host "‚ö†Ô∏è Cloudflared process not found! Attempting restart..."
              $exe = "$env:ProgramFiles\cloudflared\cloudflared.exe"
              Start-Process -NoNewWindow -FilePath $exe -ArgumentList "tunnel", "--no-autoupdate", "run", "--token=$env:TUNNEL_TOKEN"
              Start-Sleep -Seconds 10
            }
            
            Start-Sleep -Seconds 300
          }
