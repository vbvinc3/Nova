name: Secure RDP (Allow only 47.15.78.106 + Tailscale)

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Enable RDP and Core Settings
        run: |
          Write-Host "Enabling Remote Desktop..."
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
              -Name "fDenyTSConnections" -Value 0 -Force
          # Optionally keep NLA disabled if needed (some RDP clients require it)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
              -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
              -Name "SecurityLayer" -Value 0 -Force
          Restart-Service -Name TermService -Force
          Write-Host "RDP enabled."

      - name: Create / Update RDP User with Strong Password
        id: create_user
        run: |
          Write-Host "Creating local user 'RDP' with a random strong password..."
          Add-Type -AssemblyName System.Security
          $charSet = @{
              Upper   = [char[]](65..90)
              Lower   = [char[]](97..122)
              Number  = [char[]](48..57)
              Special = ([char[]](33..47) + [char[]](58..64) + [char[]](91..96) + [char[]](123..126))
          }
          $rawPassword = @()
          $rawPassword += $charSet.Upper | Get-Random -Count 4
          $rawPassword += $charSet.Lower | Get-Random -Count 4
          $rawPassword += $charSet.Number | Get-Random -Count 4
          $rawPassword += $charSet.Special | Get-Random -Count 4
          $password = -join ($rawPassword | Sort-Object { Get-Random })
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force

          if (-not (Get-LocalUser -Name "RDP" -ErrorAction SilentlyContinue)) {
              New-LocalUser -Name "RDP" -Password $securePass -AccountNeverExpires -Description "Temporary RDP user created by workflow"
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP"
              Add-LocalGroupMember -Group "Administrators" -Member "RDP"
              Write-Host "User 'RDP' created."
          } else {
              Write-Host "User 'RDP' exists. Updating password and ensuring group membership..."
              (Get-LocalUser -Name "RDP") | Set-LocalUser -Password $securePass
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDP" -ErrorAction SilentlyContinue
              Add-LocalGroupMember -Group "Administrators" -Member "RDP" -ErrorAction SilentlyContinue
          }

          # Save credentials as environment variable for later steps (visible in workflow log)
          echo "RDP_CREDS=User: RDP | Password: $password" >> $env:GITHUB_ENV
          Write-Host "RDP credentials stored in GITHUB_ENV (visible in logs)."

      - name: Install Tailscale (optional but attempted)
        run: |
          Write-Host "Installing Tailscale..."
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          try {
              Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath -UseBasicParsing -TimeoutSec 60
              Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
              Remove-Item $installerPath -Force
              Write-Host "Tailscale installer finished (if download succeeded)."
          } catch {
              Write-Warning "Tailscale install failed or download failed: $_"
          }

      - name: Attempt to bring up Tailscale (if auth key provided)
        if: ${{ secrets.TAILSCALE_AUTH_KEY != '' }}
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          # Try common paths for tailscale.exe
          $possiblePaths = @(
            "$env:ProgramFiles\Tailscale\tailscale.exe",
            "$env:ProgramFiles\Tailscale IPN\tailscale.exe"
          )
          $tailscaleExe = $possiblePaths | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $tailscaleExe) {
              Write-Warning "tailscale.exe not found; skipping tailscale up."
              exit 0
          }
          Write-Host "Bringing Tailscale up using provided auth key (non-interactive)..."
          & $tailscaleExe up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=gh-runner-$env:GITHUB_RUN_ID 2>&1 | Write-Host
          # Wait a bit for IP to appear
          Start-Sleep -Seconds 6
          $tsIP = & $tailscaleExe ip -4 2>$null
          if ($tsIP) {
              Write-Host "Tailscale IP detected: $tsIP"
              echo "TAILSCALE_IP=$tsIP" >> $env:GITHUB_ENV
          } else {
              Write-Warning "No Tailscale IP assigned yet (Tailscale up may have failed or is still provisioning)."
          }

      - name: Configure Firewall (Allow only 47.15.78.106 + Tailscale if present)
        run: |
          Write-Host "Configuring firewall to allow only your static IP and Tailscale (if present)..."

          # Your trusted static public IP
          $staticIP = "47.15.78.106"

          # Detect runner public IP (for your information)
          try {
              $public = (Invoke-WebRequest -Uri "https://api.ipify.org" -UseBasicParsing -TimeoutSec 10).Content.Trim()
          } catch {
              Write-Warning "Primary IP check failed, trying backup..."
              try {
                  $public = (Invoke-WebRequest -Uri "https://ifconfig.me/ip" -UseBasicParsing -TimeoutSec 10).Content.Trim()
              } catch {
                  $public = "UNKNOWN"
              }
          }
          Write-Host "Runner public IP (detected): $public"

          # Try to get Tailscale IP assigned to this runner (if any)
          $possiblePaths = @(
            "$env:ProgramFiles\Tailscale\tailscale.exe",
            "$env:ProgramFiles\Tailscale IPN\tailscale.exe"
          )
          $tailscaleExe = $possiblePaths | Where-Object { Test-Path $_ } | Select-Object -First 1

          $tsIP = $null
          if ($tailscaleExe) {
              try {
                  $tsIP = & $tailscaleExe ip -4 2>$null
              } catch {
                  Write-Warning "Failed to query tailscale IP: $_"
              }
          }

          if ($tsIP) {
              Write-Host "Detected Tailscale IP for runner: $tsIP"
          } else {
              Write-Host "No Tailscale IP detected; firewall will still allow static IP $staticIP."
          }

          # Combine allowed IPs: static IP always allowed; include Tailscale IP only if present
          $allowed = @($staticIP)
          if ($tsIP) { $allowed += $tsIP }
          $remoteList = $allowed -join ","

          Write-Host "Allowed remote IPs for RDP: $remoteList"

          # Remove existing rules from previous runs (avoid duplicates)
          netsh advfirewall firewall delete rule name="RDP-Allow" 2>$null
          netsh advfirewall firewall delete rule name="RDP-Deny-All" 2>$null

          # Add allow rule for specific IPs (works even if tailscale not running)
          netsh advfirewall firewall add rule name="RDP-Allow" dir=in action=allow protocol=TCP localport=3389 remoteip=$remoteList profile=any

          # Add deny-all for everyone else (protects from public scans)
          netsh advfirewall firewall add rule name="RDP-Deny-All" dir=in action=block protocol=TCP localport=3389 remoteip=any profile=any

          Write-Host "Firewall configured."

      - name: Show Connection Info (public IP, Tailscale IP if any, credentials)
        run: |
          Write-Host "`n===== Connection Info ====="
          # Detected public IP of the runner (not required for connecting; info only)
          try {
              $runnerPublic = (Invoke-WebRequest -Uri "https://api.ipify.org" -UseBasicParsing -TimeoutSec 10).Content.Trim()
          } catch {
              $runnerPublic = "UNKNOWN"
          }
          Write-Host "Runner public IP: $runnerPublic"

          # Tailscale IP (if set earlier in env)
          if ($env:TAILSCALE_IP) {
              Write-Host "Runner Tailscale IP: $env:TAILSCALE_IP"
          } else {
              # Try to detect now
              $possiblePaths = @(
                "$env:ProgramFiles\Tailscale\tailscale.exe",
                "$env:ProgramFiles\Tailscale IPN\tailscale.exe"
              )
              $tailscaleExe = $possiblePaths | Where-Object { Test-Path $_ } | Select-Object -First 1
              if ($tailscaleExe) {
                  $nowIP = & $tailscaleExe ip -4 2>$null
                  if ($nowIP) { Write-Host "Runner Tailscale IP: $nowIP" }
                  else { Write-Host "Runner Tailscale IP: (none)" }
              } else {
                  Write-Host "Tailscale not installed or not found."
              }
          }

          # Print credentials (they were saved to GITHUB_ENV earlier)
          Write-Host "RDP credentials (also in GITHUB_ENV):"
          if ($env:RDP_CREDS) {
              Write-Host $env:RDP_CREDS
          } else {
              Write-Host "(Credentials not found in environment - user creation may have failed.)"
          }
          Write-Host "============================`n"

      - name: Keep Runner Alive (Use Cancel workflow to stop)
        run: |
          Write-Host "Runner will stay alive. Cancel the workflow from Actions to stop the RDP server."
          while ($true) {
              Write-Host "[$(Get-Date -Format o)] RDP active..."
              Start-Sleep -Seconds 300
          }
